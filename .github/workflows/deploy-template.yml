name: Reusable ECR Deploy Template

on:
  workflow_call:
    inputs:
      app_name:
        description: "App name (e.g., frontend, backend)"
        required: true
        type: string
      build_context:
        description: "Path to build context (e.g., ./)"
        required: true
        type: string
      docker_port:
        description: "Port to expose"
        required: true
        type: string
      network_name:
        description: "Docker network to use"
        required: false
        type: string
        default: fast-net
      env_file_path:
        description: "Path to .run_env on EC2"
        required: true
        type: string
      repo_name:
        type: string
        required: true
      environment_name:
        type: string
        required: true

    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      EC2_HOST:
        required: true
      EC2_USER:
        required: true
      EC2_SSH_KEY:
        required: true

env:
  AWS_REGION: af-south-1
  PROJECT_NAME: fast-umsebenzi-dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{inputs.environment_name}}
    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üîê Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2


      - name: üîê Add SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: üöÄ Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            APP_NAME="${{ inputs.app_name }}"
          
            IMAGE_TAG="${{ env.IMAGE_TAG }}"
            NETWORK_NAME="${{ inputs.network_name }}"
          
            IMAGE="408595458212.dkr.ecr.af-south-1.amazonaws.com/fast-umsebenzi-dev-backend:ddb88475c6a4b09191a98aec73129f479b85a705"

            echo "üîê Logging in to ECR..."
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.ecr.outputs.registry }}

            echo "üìÇ Preparing /home/svc_user/deployments"
            mkdir -p /home/svc_user/deployments
            cd /home/svc_user/deployments

            echo "üì¶ Pulling image $IMAGE"
            docker pull $IMAGE

            echo "üßπ Stopping old container..."
            docker stop $APP_NAME || true
            docker rm $APP_NAME || true

            echo "üîß Ensuring network exists..."
            docker network create $NETWORK_NAME || true

            echo "üöÄ Running $APP_NAME..."
            docker run -d \
              --name $APP_NAME \
              --network $NETWORK_NAME \
              --env-file ${{ inputs.env_file_path }} \
              -p ${{ inputs.docker_port }}:${{ inputs.docker_port }} \
              $IMAGE

            echo "üßπ Cleaning up unused Docker images..."
            docker image prune -af || true

            echo "üëã Logging out of ECR..."
            docker logout ${{ steps.ecr.outputs.registry }}

            echo "‚úÖ Deployment complete!"
          EOF
