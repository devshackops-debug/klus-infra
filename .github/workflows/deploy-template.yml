name: Reusable ECR Deploy Template

on:
  workflow_call:
    inputs:
      app_name:
        description: "App name (e.g., frontend, backend)"
        required: true
        type: string
      build_context:
        description: "Path to build context (e.g., ./api or ./frontend)"
        required: true
        type: string
      docker_port:
        description: "Container port to expose"
        required: true
        type: string
      app_external_port:
        type: string
        description: "External port to expose"
        required: true
      network_name:
        description: "Docker network name on EC2"
        required: false
        type: string
        default: fast-net
      env_file_path:
        description: "Path to .run_env on EC2"
        required: true
        type: string
      repo_name:
        description: "Full ECR repo URL (e.g., 123456789012.dkr.ecr.af-south-1.amazonaws.com)"
        type: string
        required: true
      image_name:
        description: "Image name within the repository"
        type: string
        required: true
      environment_name:
        description: "GitHub environment to pull secrets from"
        type: string
        required: true

    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      EC2_HOST:
        required: true
      EC2_USER:
        required: true
      EC2_SSH_KEY:
        required: true

env:
  AWS_REGION: af-south-1
  PROJECT_NAME: fast-umsebenzi-dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment_name }}

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ—ï¸ Build Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_NAME=${{ inputs.image_name }}
          FULL_IMAGE="${{ inputs.repo_name }}/${IMAGE_NAME}:${IMAGE_TAG}"

          echo "ğŸ§± Building image: $FULL_IMAGE"
          docker build -t $IMAGE_NAME:${IMAGE_TAG} ${{ inputs.build_context }}

          docker tag $IMAGE_NAME:${IMAGE_TAG} $FULL_IMAGE
          docker tag $IMAGE_NAME:${IMAGE_TAG} ${{ inputs.repo_name }}/${IMAGE_NAME}:latest

          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "FULL_IMAGE=${FULL_IMAGE}" >> $GITHUB_ENV

      - name: ğŸš€ Push image to ECR
        run: |
          docker push ${{ env.FULL_IMAGE }}
          docker push ${{ inputs.repo_name }}/${{ inputs.image_name }}:latest

      - name: ğŸ” Add SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: |
            ${{ secrets.EC2_SSH_KEY }}

      - name: ğŸš€ Deploy on EC2
        run: |
          echo "ğŸ”— Connecting to EC2..."
          ssh -o StrictHostKeyChecking=no -o BatchMode=yes \
            -t ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            APP_NAME=${{ inputs.app_name }} \
            IMAGE_TAG=${{ github.sha }} \
            NETWORK_NAME=${{ inputs.network_name }} \
            IMAGE="${{ inputs.repo_name }}/${{ inputs.image_name }}:${{ github.sha }}" \
            DOCKER_PORT=${{ inputs.docker_port }} \
            APP_EXTERNAL_PORT=${{ inputs.app_external_port }} \
            ENV_FILE=${{ inputs.env_file_path }} \
            AWS_REGION=${{ env.AWS_REGION }} \
            REPO_NAME=${{ inputs.repo_name }} \
          'bash -s' <<'EOF'
            set -e
            trap 'echo "âŒ Deployment failed on line $LINENO"' ERR
          
            echo "ğŸ“‚ Preparing /home/svc_user/deployments"
            mkdir -p /home/svc_user/deployments
            cd /home/svc_user/deployments
          
            echo "ğŸ” Checking Docker daemon..."
            if ! sudo systemctl is-active --quiet docker; then
              echo "ğŸ”§ Starting Docker daemon..."
              sudo systemctl start docker
              sleep 5
            fi
          
            echo "ğŸ” Fixing Docker socket permissions..."
            sudo chown root:docker /var/run/docker.sock || true
            sudo chmod 660 /var/run/docker.sock || true
          
            echo "ğŸ” Logging into Amazon ECR..."
            aws ecr get-login-password --region "$AWS_REGION" \
              | sudo docker login --username AWS --password-stdin "$REPO_NAME"
          
            echo "ğŸ“¦ Pulling image $IMAGE"
            sudo docker pull "$IMAGE"
          
            echo "ğŸ§¹ Stopping old container..."
            sudo docker stop "$APP_NAME" || true
            sudo docker rm "$APP_NAME" || true
          
            echo "ğŸ”§ Ensuring Docker network exists..."
            sudo docker network create "$NETWORK_NAME" || true
          
            echo "ğŸš€ Starting container $APP_NAME..."
            sudo docker run -d \
              --name "$APP_NAME" \
              --network "$NETWORK_NAME" \
              --env-file "$ENV_FILE" \
              -v shared_volume:/shared \
              -p "APP_EXTERNAL_PORT:$DOCKER_PORT" \
              "$IMAGE"
          
            echo "ğŸ§¹ Cleaning up old images..."
            sudo docker image prune -af || true
          
            echo "ğŸ‘‹ Logging out of ECR..."
            sudo docker logout "$REPO_NAME" || true
          
            echo "âœ… Deployment complete!"
          EOF
